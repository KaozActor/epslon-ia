<!DOCTYPE html>
<html>
<head>
    <title>IA do Evento RPG (Generativa Aprimorada)</title>
    <style>
        body { font-family: sans-serif; }
        #chat { width: 600px; margin: 20px auto; border: 1px solid #ccc; padding: 10px; }
        #input-area { margin-bottom: 10px; }
        #resposta-area { padding: 10px; border-top: 1px solid #ccc; }
        #resposta { word-wrap: break-word; }
        input[type="text"] { width: 80%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 8px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #3e8e41; }
    </style>
</head>
<body>
    <div id="chat">
        <h1>IA do Evento RPG</h1>
        <div id="input-area">
            <input type="text" id="pergunta" placeholder="Faça sua pergunta">
            <button onclick="enviarPergunta()">Enviar</button>
        </div>
        <div id="resposta-area">
            <p id="resposta">Olá! Sou a IA do evento. Faça uma pergunta.</p>
        </div>
    </div>

    <script>
        const planilhaURL = 'https://docs.google.com/spreadsheets/d/15J3iJ-320B71-TrGNaP-X5LQT8tDVP0F3utKEzx4ATA/gviz/tq?tqx=out:csv&sheet=Sheet1';

const frases = {
    introducao: [
        "Hum, deixe-me ver...",
        "Sobre isso...",
        "Interessante questão!",
        "Posso te dizer que...",
        "Deixe-me pensar um pouco...",
        "Ah, sim, sobre isso..."
    ],
    conclusao: [
        "Espero ter ajudado!",
        "Essa é a informação que tenho.",
        "É tudo que sei.",
        "Espero que isso ajude em sua jornada!",
        "Se precisar de mais algo, me diga."
    ],
    desconhecido: [
        "Não tenho essa informação no momento.",
        "Não sei responder a essa pergunta.",
        "Essa informação me escapa."
    ]
};

function enviarPergunta() {
    const pergunta = document.getElementById('pergunta').value.toLowerCase();
    const respostaArea = document.getElementById('resposta');
    respostaArea.textContent = 'Carregando...';

    fetch(planilhaURL)
        .then(response => response.text())
        .then(data => {
            const linhas = data.split('\n');
            const bancoDeDados = [];

            // Verifica se há linhas e se a primeira linha contém os nomes das colunas
            if (linhas.length > 1) {
                const nomesColunas = linhas[0].split(',');
                const colunaEntidade = nomesColunas.indexOf('Entidade');
                const colunaAtributo = nomesColunas.indexOf('Atributo');
                const colunaValor = nomesColunas.indexOf('Valor');

                // Verifica se as colunas necessárias existem
                if (colunaEntidade > -1 && colunaAtributo > -1 && colunaValor > -1) {
                    for (let i = 1; i < linhas.length; i++) {
                        const colunas = linhas[i].split(',');
                        if (colunas.length >= 3) {
                            bancoDeDados.push({
                                entidade: colunas[colunaEntidade].toLowerCase().trim(),
                                atributo: colunas[colunaAtributo].toLowerCase().trim(),
                                valores: colunas[colunaValor].trim().split(';').map(v => v.trim()),
                            });
                        }
                    }
                } else {
                    respostaArea.textContent = "Erro: As colunas 'Entidade', 'Atributo' e 'Valor' não foram encontradas na planilha.";
                    return; // Impede a execução do restante do código se as colunas não forem encontradas
                }
            } else {
                respostaArea.textContent = "Erro: A planilha está vazia ou o formato está incorreto.";
                return; // Impede a execução do restante do código se não houver dados
            }

            let resposta = frases.desconhecido[Math.floor(Math.random() * frases.desconhecido.length)];
            const palavrasChave = pergunta.split(' ');
            let entidadeEncontrada = null;
            let atributoEncontrado = null;

            // Busca por entidades e atributos que correspondam a pergunta
            for (const item of bancoDeDados) {
                 if (palavrasChave.some(palavra => item.entidade.includes(palavra) || item.atributo.includes(palavra))) {
                    entidadeEncontrada = item.entidade;
                    atributoEncontrado = item.atributo;
                    break;
                }
            }


            if (entidadeEncontrada && atributoEncontrado) {
                // Tenta responder com base nas palavras-chave
                for (const item of bancoDeDados) {
                    if (item.entidade === entidadeEncontrada && item.atributo === atributoEncontrado) {
                        const valor = item.valores[Math.floor(Math.random() * item.valores.length)];
                        let frase = '';

                        if (pergunta.includes(item.entidade) && pergunta.includes(item.atributo)) {
                            frase = `${item.entidade} tem ${item.atributo} que é ${valor}.`;
                        } else if (pergunta.includes(item.entidade)) {
                            frase = `${item.entidade} ${item.atributo} é ${valor}.`;
                        } else if (pergunta.includes(item.atributo)) {
                            frase = `O ${item.atributo} de ${item.entidade} é ${valor}.`; // Mais natural
                        }

                        const introducao = frases.introducao[Math.floor(Math.random() * frases.introducao.length)];
                        const conclusao = frases.conclusao[Math.floor(Math.random() * frases.conclusao.length)];
                        resposta = `${introducao} ${frase} ${conclusao}`;
                        break; // Encontrou, então para
                    }
                }
            }

            respostaArea.textContent = resposta;
        })
        .catch(error => {
            respostaArea.textContent = 'Erro ao obter resposta.';
            console.error('Erro:', error);
        });
}
    </script>
</body>
</html>
